<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Game Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #1a202c; color: #e2e8f0; }
        .btn { @apply w-full px-4 py-3 text-lg font-bold text-white rounded-lg shadow-md transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900; }
        .btn-primary { @apply bg-indigo-600 hover:bg-indigo-700 focus:ring-indigo-500; }
        .btn-secondary { @apply bg-gray-600 hover:bg-gray-700 focus:ring-gray-500; }
        .btn-correct { @apply bg-green-500 !important; animation: pulse-green 1s infinite; }
        .btn-wrong { @apply bg-red-500 !important; }
        .btn-selected { @apply ring-4 ring-yellow-400 ring-offset-2 ring-offset-gray-800; }
        .card { @apply bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl border border-gray-700; }
        .screen { display: none; }
        .active-screen { display: flex; }
        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-2xl mx-auto">
        <!-- Screen 1: Login -->
        <div id="login-screen" class="screen active-screen flex-col items-center justify-center">
            <div class="card w-full text-center">
                <h1 class="text-4xl font-bold mb-2 text-white">Quiz Challenge</h1>
                <p class="text-gray-400 mb-6">เกมส์ทายปัญหาประลองความรู้</p>
                <div class="space-y-4">
                    <input type="text" id="name-input" placeholder="กรุณากรอกชื่อของคุณ..." class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <input type="text" id="game-id-input" placeholder="กรอกรหัสห้องเกมจาก Host..." class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button id="join-btn" class="btn btn-primary">เข้าร่วมเกม</button>
                </div>
            </div>
        </div>

        <!-- Other Screens (Lobby, Question, etc.) -->
        <div id="lobby-screen" class="screen flex-col items-center justify-center">
             <div class="card w-full">
                <h2 class="text-3xl font-bold text-center text-white mb-4">ห้องรอเล่น</h2>
                <p class="text-center text-gray-400 mb-6">กำลังรอเจ้าของเกม (Host) เริ่มเกม...</p>
                <div class="bg-gray-900 p-4 rounded-lg mb-6 min-h-[120px]">
                    <h3 class="font-semibold mb-2 text-indigo-400">ผู้เล่นในห้อง:</h3>
                    <ul id="player-list" class="list-disc list-inside text-white space-y-1"></ul>
                </div>
            </div>
        </div>
        <div id="question-screen" class="screen flex-col">
            <div class="card w-full">
                <h2 id="question-number" class="text-xl font-bold text-indigo-400"></h2>
                <p id="question-text" class="text-2xl font-semibold text-center text-white min-h-[100px] my-8">...</p>
                <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                <p id="wait-for-reveal-msg" class="text-center mt-6 text-yellow-400 hidden">คุณตอบแล้ว! รอ Host เฉลยคำตอบ...</p>
            </div>
        </div>
        <div id="reveal-screen" class="screen flex-col">
            <div class="card w-full text-center">
                <p id="reveal-result" class="text-4xl font-bold mb-6"></p>
                <div id="reveal-options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"></div>
                <div class="bg-gray-900 p-4 rounded-lg">
                    <h3 class="font-semibold mb-2 text-indigo-400">ตารางคะแนนปัจจุบัน</h3>
                    <ul id="reveal-scoreboard" class="space-y-1"></ul>
                </div>
            </div>
        </div>
        <div id="scoreboard-screen" class="screen flex-col">
            <div class="card w-full text-center">
                <h2 class="text-4xl font-bold text-white mb-4">สรุปผลคะแนน</h2>
                <div id="final-scoreboard" class="space-y-2"></div>
                <p class="mt-8 text-gray-400">รอ Host เริ่มเกมใหม่อีกครั้ง...</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, onSnapshot, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "test", authDomain: "test.firebaseapp.com", projectId: "test" };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let gameUnsubscribe = null;
        let currentGameId = null;

        const screens = {
            login: document.getElementById('login-screen'),
            lobby: document.getElementById('lobby-screen'),
            question: document.getElementById('question-screen'),
            reveal: document.getElementById('reveal-screen'),
            scoreboard: document.getElementById('scoreboard-screen')
        };
        const nameInput = document.getElementById('name-input');
        const gameIdInput = document.getElementById('game-id-input');
        const joinBtn = document.getElementById('join-btn');

        async function main() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                } else {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Authentication failed:", error);
                    }
                }
            });
        }

        joinBtn.addEventListener('click', async () => {
            const name = nameInput.value.trim();
            const gameId = gameIdInput.value.trim();
            if (!name || !gameId) {
                alert('กรุณากรอกชื่อและรหัสห้องเกม');
                return;
            }
            if (!currentUser) {
                alert('ยังไม่พร้อมเชื่อมต่อ กรุณารอสักครู่');
                return;
            }

            joinBtn.disabled = true;
            joinBtn.textContent = 'กำลังเข้าร่วม...';
            currentGameId = gameId;
            
            await joinGame(name, gameId);
        });

        async function joinGame(name, gameId) {
            const gameRef = doc(db, "artifacts", gameId, "public/data/quiz-game", "game-room");
            try {
                const gameDoc = await getDoc(gameRef);
                if (!gameDoc.exists()) {
                    alert('ไม่พบห้องเกมนี้! กรุณาตรวจสอบรหัสอีกครั้ง');
                    joinBtn.disabled = false;
                    joinBtn.textContent = 'เข้าร่วมเกม';
                    return;
                }

                const gameData = gameDoc.data();
                const playerExists = gameData.players.some(p => p.uid === currentUser.uid);
                if (!playerExists) {
                    await updateDoc(gameRef, {
                        players: arrayUnion({ uid: currentUser.uid, name: name, score: 0, answer: null })
                    });
                }
                
                attachGameListener(gameId);
            } catch (error) {
                console.error("Error joining game:", error);
                alert("เกิดข้อผิดพลาดในการเข้าร่วมเกม");
                joinBtn.disabled = false;
                joinBtn.textContent = 'เข้าร่วมเกม';
            }
        }
        
        function attachGameListener(gameId) {
            if (gameUnsubscribe) gameUnsubscribe();
            const gameRef = doc(db, "artifacts", gameId, "public/data/quiz-game", "game-room");
            gameUnsubscribe = onSnapshot(gameRef, (doc) => {
                if (doc.exists()) {
                    renderGame(doc.data());
                } else {
                    alert("ห้องเกมถูกปิดแล้ว");
                    showScreen('login');
                    gameIdInput.value = '';
                    joinBtn.disabled = false;
                    joinBtn.textContent = 'เข้าร่วมเกม';
                }
            });
        }

        function renderGame(gameData) {
            const self = gameData.players.find(p => p.uid === currentUser.uid);
            if (!self) { 
                showScreen('login');
                return; 
            }

            const { gameState, players, currentQuestionIndex, questions } = gameData;
            
            // Shared rendering for lobby
            const playerList = document.getElementById('player-list');
            if (playerList) {
                playerList.innerHTML = players.map(p => `<li class="${p.uid === currentUser.uid ? 'font-bold text-yellow-300' : ''}">${p.name}</li>`).join('');
            }
            
            switch (gameState) {
                case 'LOBBY': showScreen('lobby'); break;
                case 'QUESTION': showScreen('question'); renderQuestion(gameData, self); break;
                case 'REVEAL': showScreen('reveal'); renderReveal(gameData, self); break;
                case 'SCOREBOARD': showScreen('scoreboard'); renderScoreboard(players); break;
            }
        }

        function showScreen(screenName) {
            Object.values(screens).forEach(screen => screen.classList.remove('active-screen'));
            screens[screenName].classList.add('active-screen');
        }

        function renderQuestion(gameData, self) {
            const { currentQuestionIndex, questions } = gameData;
            const question = questions[currentQuestionIndex];
            
            document.getElementById('question-number').textContent = `คำถามข้อที่ ${currentQuestionIndex + 1}`;
            document.getElementById('question-text').textContent = question.question;

            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            
            const hasAnswered = self.answer !== null;
            document.getElementById('wait-for-reveal-msg').classList.toggle('hidden', !hasAnswered);

            question.options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('btn', 'btn-secondary');
                if (hasAnswered) {
                    button.disabled = true;
                    if (option === self.answer) button.classList.add('btn-selected');
                }
                button.addEventListener('click', () => handleAnswer(option, gameData));
                optionsContainer.appendChild(button);
            });
        }
        
        async function handleAnswer(selectedOption, gameData) {
            document.querySelectorAll('#options-container button').forEach(b => b.disabled = true);
            const gameRef = doc(db, "artifacts", currentGameId, "public/data/quiz-game", "game-room");
            const updatedPlayers = gameData.players.map(p => {
                if (p.uid === currentUser.uid) return { ...p, answer: selectedOption };
                return p;
            });
            await updateDoc(gameRef, { players: updatedPlayers });
        }

        function renderReveal(gameData, self) {
            const { currentQuestionIndex, questions, players } = gameData;
            const question = questions[currentQuestionIndex];
            const correctAnswer = question.answer;
            
            const revealResult = document.getElementById('reveal-result');
            revealResult.textContent = self.answer === correctAnswer ? 'ถูกต้อง!' : 'ผิดจ้า!';
            revealResult.className = `text-4xl font-bold mb-6 ${self.answer === correctAnswer ? 'text-green-400' : 'text-red-400'}`;

            const optionsContainer = document.getElementById('reveal-options-container');
            optionsContainer.innerHTML = '';
            question.options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('btn', 'btn-secondary');
                button.disabled = true;
                if (option === correctAnswer) button.classList.add('btn-correct');
                else if (option === self.answer) button.classList.add('btn-wrong');
                optionsContainer.appendChild(button);
            });

            const sortedPlayers = [...players].sort((a, b) => b.score - a.score);
            document.getElementById('reveal-scoreboard').innerHTML = sortedPlayers.map(p => 
                `<li class="flex justify-between ${p.uid === currentUser.uid ? 'font-bold text-yellow-300' : 'text-white'}">
                    <span>${p.name}</span>
                    <span>${p.score} คะแนน</span>
                </li>`
            ).join('');
        }

        function renderScoreboard(players) {
            const finalScoreboard = document.getElementById('final-scoreboard');
            const sortedPlayers = [...players].sort((a, b) => b.score - a.score);
            finalScoreboard.innerHTML = sortedPlayers.map((p, index) => {
                let medal = ['🥇', '🥈', '🥉'][index] || '';
                return `<div class="flex items-center justify-between p-3 rounded-lg ${index === 0 ? 'bg-yellow-500/20' : 'bg-gray-700'}">
                            <span class="text-xl font-bold ${p.uid === currentUser.uid ? 'text-yellow-300' : 'text-white'}">${medal} ${p.name}</span>
                            <span class="text-xl font-bold text-white">${p.score} คะแนน</span>
                        </div>`;
            }).join('');
        }

        main();
    </script>
</body>
</html>
