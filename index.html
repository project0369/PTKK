<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แจ้งเตือนพลิกตัวคนไข้</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            touch-action: manipulation; /* ป้องกันการซูมเมื่อแตะสองครั้งบนมือถือ */
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            transition: background-color 0.3s ease;
        }
        .status-inactive { background-color: #f87171; } /* red-400 */
        .status-active { background-color: #4ade80; } /* green-400 */
        .btn-shadow {
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .btn-shadow:active {
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            transform: translateY(1px);
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen">

    <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 m-4 w-full max-w-md text-center">
        
        <!-- Header -->
        <div class="flex flex-col items-center">
            <svg class="w-16 h-16 text-blue-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
            </svg>
            <h1 class="text-2xl md:text-3xl font-bold text-slate-800">ระบบแจ้งเตือนพลิกตัว</h1>
            <p class="text-slate-500 mt-2">ตั้งค่าการแจ้งเตือนทุก 2 ชั่วโมง เพื่อป้องกันแผลกดทับ</p>
        </div>

        <!-- Status -->
        <div class="mt-8 bg-slate-50 rounded-lg p-4 flex items-center justify-center space-x-3">
            <span id="status-dot" class="status-dot status-inactive"></span>
            <span id="status-text" class="text-slate-700 font-semibold">สถานะ: ปิดใช้งาน</span>
        </div>
        
        <!-- Action Button -->
        <div class="mt-8">
            <button id="toggleButton" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 btn-shadow focus:outline-none focus:ring-2 focus:ring-blue-400">
                เริ่มการแจ้งเตือน
            </button>
        </div>

        <!-- Info -->
        <div class="mt-6 text-xs text-slate-400">
            <p>แอปจะทำงานเบื้องหลังและแจ้งเตือนแม้ปิดเบราว์เซอร์ไปแล้ว</p>
        </div>

    </div>

    <!-- Service Worker and Main Logic -->
    <script>
        const toggleButton = document.getElementById('toggleButton');
        const statusText = document.getElementById('status-text');
        const statusDot = document.getElementById('status-dot');
        let isReminderActive = false;

        // ตรวจสอบว่าเบราว์เซอร์รองรับ Service Worker และ Notifications หรือไม่
        if (!('serviceWorker' in navigator) || !('Notification' in window)) {
            alert('ขออภัย เบราว์เซอร์ของคุณไม่รองรับฟังก์ชันการแจ้งเตือนเบื้องหลัง');
            toggleButton.disabled = true;
            toggleButton.textContent = 'ไม่รองรับ';
        }

        // ฟังก์ชันอัปเดต UI
        function updateUI(isActive) {
            isReminderActive = isActive;
            if (isActive) {
                statusText.textContent = 'สถานะ: ทำงานอยู่';
                statusDot.classList.remove('status-inactive');
                statusDot.classList.add('status-active');
                toggleButton.textContent = 'หยุดการแจ้งเตือน';
                toggleButton.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                toggleButton.classList.add('bg-red-500', 'hover:bg-red-600');
            } else {
                statusText.textContent = 'สถานะ: ปิดใช้งาน';
                statusDot.classList.remove('status-active');
                statusDot.classList.add('status-inactive');
                toggleButton.textContent = 'เริ่มการแจ้งเตือน';
                toggleButton.classList.remove('bg-red-500', 'hover:bg-red-600');
                toggleButton.classList.add('bg-blue-500', 'hover:bg-blue-600');
            }
        }

        // ฟังก์ชันเริ่มการแจ้งเตือน
        async function startReminder() {
            // 1. ขออนุญาตแสดง Notification
            const permission = await Notification.requestPermission();
            if (permission !== 'granted') {
                alert('คุณต้องอนุญาตการแจ้งเตือนเพื่อใช้งานฟังก์ชันนี้');
                return;
            }

            // 2. ลงทะเบียน Service Worker
            try {
                const registration = await navigator.serviceWorker.register('sw.js');
                console.log('Service Worker registered:', registration);

                // รอให้ worker พร้อมทำงาน
                await navigator.serviceWorker.ready;
                
                // 3. ส่งคำสั่ง 'START' ไปยัง Service Worker
                navigator.serviceWorker.controller.postMessage({ action: 'START' });
                console.log('Sent START command to Service Worker.');
                updateUI(true);

            } catch (error) {
                console.error('Service Worker registration failed:', error);
                alert('เกิดข้อผิดพลาดในการเริ่มระบบแจ้งเตือน');
            }
        }

        // ฟังก์ชันหยุดการแจ้งเตือน
        async function stopReminder() {
            try {
                const registration = await navigator.serviceWorker.getRegistration();
                if (registration) {
                    // ส่งคำสั่ง 'STOP' ไปยัง Service Worker
                    if (navigator.serviceWorker.controller) {
                       navigator.serviceWorker.controller.postMessage({ action: 'STOP' });
                       console.log('Sent STOP command to Service Worker.');
                    }
                    // ยกเลิกการลงทะเบียน Service Worker
                    await registration.unregister();
                    console.log('Service Worker unregistered.');
                }
                updateUI(false);
            } catch (error) {
                console.error('Failed to stop reminder:', error);
                alert('เกิดข้อผิดพลาดในการหยุดระบบแจ้งเตือน');
            }
        }

        // จัดการการคลิกปุ่ม
        toggleButton.addEventListener('click', () => {
            if (isReminderActive) {
                stopReminder();
            } else {
                startReminder();
            }
        });

        // ตรวจสอบสถานะเมื่อโหลดหน้าเว็บ
        async function checkInitialState() {
            const registration = await navigator.serviceWorker.getRegistration();
            if (registration && registration.active) {
                 // หากมี Service Worker ทำงานอยู่ ให้ถือว่าเปิดใช้งานแล้ว
                 // หมายเหตุ: เราไม่สามารถรู้ได้แน่ชัดว่า interval ทำงานอยู่หรือไม่
                 // แต่เราจะตั้งค่า UI ให้สอดคล้องกับการมีอยู่ของ worker
                 updateUI(true);
            } else {
                 updateUI(false);
            }
        }

        window.addEventListener('load', checkInitialState);
    </script>
    
    <!-- This is the Service Worker file. In a real project, this would be in a separate file named sw.js -->
    <script>
        const serviceWorkerCode = `
            let intervalId = null;
            const TWO_HOURS = 2 * 60 * 60 * 1000; // 2 ชั่วโมงในหน่วยมิลลิวินาที

            function showNotification() {
                console.log('Showing notification at', new Date().toLocaleTimeString());
                self.registration.showNotification('พลิกตัวคนไข้', {
                    body: 'ได้เวลาพลิกตัวผู้ป่วยเพื่อป้องกันแผลกดทับ',
                    icon: 'https://placehold.co/192x192/3b82f6/ffffff?text=+', // ไอคอนรูปบวก
                    vibrate: [200, 100, 200], // สั่น
                    tag: 'patient-turn-reminder' // ใช้ tag เพื่อให้แจ้งเตือนใหม่ทับอันเก่า
                });
            }

            self.addEventListener('message', (event) => {
                if (event.data.action === 'START') {
                    console.log('Service Worker received START command.');
                    // เคลียร์ interval เก่า (ถ้ามี)
                    if (intervalId) {
                        clearInterval(intervalId);
                    }
                    // แสดงแจ้งเตือนทันทีครั้งแรก เพื่อให้ผู้ใช้รู้ว่าระบบเริ่มทำงานแล้ว
                    showNotification();
                    // ตั้งค่า interval ให้ทำงานทุก 2 ชั่วโมง
                    intervalId = setInterval(showNotification, TWO_HOURS);
                } else if (event.data.action === 'STOP') {
                    console.log('Service Worker received STOP command.');
                    if (intervalId) {
                        clearInterval(intervalId);
                        intervalId = null;
                        console.log('Interval cleared.');
                    }
                }
            });

            // ทำให้ service worker ทำงานทันทีที่ลงทะเบียนเสร็จ
            self.addEventListener('install', (event) => {
                self.skipWaiting();
            });

            self.addEventListener('activate', (event) => {
                console.log('Service Worker activated.');
                // ควบคุมหน้าเว็บทันที
                event.waitUntil(self.clients.claim());
            });
        `;
        // Register the service worker from a blob URL
        const blob = new Blob([serviceWorkerCode], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(blob);
        // The registration logic is in the main script block above.
        // We just need to modify the registration call to use this URL.
        // This is a workaround for single-file deployment.
        // In a real project, sw.js would be a separate file.
        // Let's modify the main script to use this blob URL.
        const originalRegister = navigator.serviceWorker.register;
        navigator.serviceWorker.register = (scriptURL, options) => {
            if (scriptURL === 'sw.js') {
                return originalRegister(swUrl, options);
            }
            return originalRegister(scriptURL, options);
        };
    </script>

</body>
</html>
